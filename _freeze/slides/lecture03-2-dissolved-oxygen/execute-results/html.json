{
  "hash": "4c996f8fbdb54d6b79e1dfda70474cdc",
  "result": {
    "engine": "julia",
    "markdown": "---\ntitle: \"Simulation Example: Dissolved Oxygen\"\nsubtitle: \"Lecture 06\"\nauthor: \"Vivek Srikrishnan\"\ncourse: \"BEE 4850\"\ninstitution: \"Cornell University\"\ndate: \"September 16, 2024\"\nformat:\n    revealjs:\n        slide-number: c/t\n        show-slide-number: all\n        center-title-slide: true\n        width: 1280\n        height: 720\n        transition: none\n        toc: true\n        toc-depth: 1\n        toc-title: \"Overview\"\n        history: false\n        link-external-newwindow: true\n        theme: ../sass/slides.scss\n        template-partials:\n            - title-slide.html\n        menu:\n            numbers: true\n        html-math-method: mathjax\n        include-in-header: mathjax-config.html\n        date-format: long\n        email-obfuscation: javascript\n        chalkboard:\n            theme: whiteboard\n            buttons: true\nengine: julia\nexecute:\n    freeze: auto\n    daemon: 600\n---\n\n\n\n\n\n\n\n\n\n\n# Review of Last Class\n\n## Last Class\n\n- Model-based simulation as a way to understand system dynamics and response.\n- Box models: mass-balance in some region of the domain\n- Can generalize single box models by:\n    - Adding more complexity;\n    - combining multiple boxes.\n\n## Why Simulate?\n\n1. System involves complex, nonlinear dynamics that may not be analytically tractable.\n2. Setting up and running a real-world experiment is not possible.\n3. State depends on prior states or states of nearby locations, so need to iterate over multiple spatial or temporal steps.\n4. Need to understand range of system performance across rarely-seen conditions.  \n\n## Questions\n\n\n:::: {.columns .center}\n::: {.column width=\"40%\"}\n![](figures/vsrikrish-poll.png){fig-alt=\"Poll Everywhere QR Code\" fig-align=\"center\" width=\"100%\"}\n:::\n::: {.column width=60%}\n**Text**: VSRIKRISH to 22333\n\n**URL**: [https://pollev.com/vsrikrish](https://pollev.com/vsrikrish)\n<br><br>\n[See Results](https://www.polleverywhere.com/multiple_choice_polls/qKeig0hHShZYHAOmvZtZm?preview=true&controls=none){preview-link=\"true\"}\n:::\n::::\n\n\n\n# Dissolved Oxygen Overview\n\n## Fate & Transport Modeling\n\n**How do nutrients and other quantities move through environmental mediums?**\n\nWhat can make fate & transport modeling more complex?\n\n::: {.fragment .fade-in}\n- Multiple points of inflow;\n- More complex growth/decay dynamics.\n- Stochasticity/randomness.\n:::\n\n## Dissolved Oxygen\n\n:::: {.columns}\n::: {.column width=50%}\nDissolved oxygen (DO) is the free, non-compound oxygen present in water or other liquids.\n\nFreshwater can only hold small amounts, and this capacity is regulated by temperature.\n:::\n\n::: {.column width=50%}\n\n![Dissolved Oxygen by temperature](https://www.fondriest.com/environmental-measurements/wp-content/uploads/2013/11/dissolvedoxygen_river-levels.jpg){width=80%}\n\n::: {.caption}\nSource: [fondriest.com](https://www.fondriest.com/environmental-measurements/parameters/water-quality/dissolved-oxygen/)\n:::\n:::\n::::\n\n## Temperature Impact on DO\n\n![Dissolved Oxygen and Temperature Plot](https://d9-wret.s3.us-west-2.amazonaws.com/assets/palladium/production/s3fs-public/thumbnails/image/do_temp_0.png)\n\n::: {.caption}\nSource: [usgs.gov](https://www.usgs.gov/special-topics/water-science-school/science/dissolved-oxygen-and-water)\n:::\n\n## Dissolved Oxygen and Life\n\n:::: {.columns}\n::: {.column width=40%}\n\nDissolved oxygen is an important nutrient for aquatic life. \n\n**Hypoxia** occurs when DO levels are $< 2$ mg/L.\n\n:::\n\n::: {.column width=50%}\n\n![Minimum DO requirements for freshwater fish](https://www.fondriest.com/environmental-measurements/wp-content/uploads/2013/11/dissolvedoxygen_levels-fresh.jpg){width=45%}\n:::\n\n:::{.column width=10%}\n\n::: {.caption}\nSource: [fondriest.com](https://www.fondriest.com/environmental-measurements/parameters/water-quality/dissolved-oxygen/)\n:::\n:::\n::::\n\n\n## Factors Influencing DO\n\n- Temperature, Pressure, Depth\n- Salinity\n- Mixing\n- Plant and Microbial Life\n- Organic Matter\n\n## Impact of Paris On Seine DO, 1874\n\n![Dissolved Oxygen Downstream of Paris, 1874](https://www.researchgate.net/publication/325721176/figure/fig10/AS:962439298445322@1606474818380/Longitudinal-profiles-x-axis-in-km-downstream-of-Paris-center-of-dissolved-oxygen_W640.jpg)\n\n::: {.caption}\nSource: Dmitrieva, T., et al. (2018). <https://doi.org/10.1007/s12685-018-0216-7>\n:::\n\n## DO Regulatory Standards\n\n**Objective**: Keep DO *above* the regulatory standard.\n\nIn NY (via [Westlaw](https://govt.westlaw.com/nycrr/Document/I4ed90412cd1711dda432a117e6e0f345?viewType=FullText&originationContext=documenttoc&transitionType=CategoryPageItem&contextData=(sc.Default)&bhcp=1)): \n\n- DO levels may not fall below 3 mg/L\n- DO may not be below 4.8 mg/L for an extended period\n\n# Modeling Dissolved Oxygen\n\n## Oxygen Balance in Rivers and Streams\n\n![Processes influencing oxygen balance in moving freshwater](images/do-processes.svg){height=100%}\n\n## Selecting a Metric for DO Fluxes\n\nTypically use **oxygen demand** (OD): \n\n- measure of the concentration of oxidizable materials in a water sample\n- metric for organic waste contamination\n- reflects how oxygen will be depleted in a given segment\n\nBut there are several different processes affecting total OD!\n\n## Biochemical Oxygen Demand (BOD)\n\nOxygen used by microbes during aerobic decomposition of organic materials:\n$$\\text{Organic Matter} + \\text{O}_2 \\rightarrow \\text{CO}_2 +  \\text{H}_2\\text{O} + \\text{NO}_3 + \\text{SO}_2 + \\text{Residuals}$$\n\nBroadly speaking, we care about two types of BOD: **Carbonaceous BOD** and **Nitrogenous BOD**.\n\n## Carbonaceous BOD (CBOD)\n\nOxygen consumed during microbial decomposition of carbon compounds, *e.g.*:\n$$\\text{C}_a\\text{H}_b\\text{O}_c + d\\text{O}_2 \\rightarrow e\\text{H}_2\\text{O} + f\\text{CO}_2$$\n\n## Nitrogenous BOD (NBOD)\n\nOxygen consumed during microbial decomposition of nitrogen compounds:\n$$2\\text{NH}_2^+ + 4\\text{O}_2 \\rightarrow 2\\text{H}_2\\text{O} + 4\\text{H}^+ + 2\\text{NO}_3^-$$\n\n## BOD and Time\n\nMoreover, BOD is differentiated based on time frame, *e.g.*:\n\n- BOD<sub>5</sub>: oxygen demand over 5 days\n- BOD<sub>20</sub>: oxygen demand over 20 days\n\n## DO Modeling Needs\n\nNeed a model that will predict DO as a function of CBOD, NBOD.\n\nUse a *fate and transport* modeling approach: how are relevant quantities moved downstream?\n\n**Note**: Can't assume homogeneous processes.\n\n## Modeling DO\n\n:::: {.columns}\n::: {.column width=30%}\nSo what do we do?\n\nStart by assuming *steady-state* waste in each section (or box...).\n\n:::\n::: {.column width=70%}\n\n![Processes influencing oxygen balance in moving freshwater](figures/do-processes.svg)\n:::\n::::\n\n## Modeling DO\n\n:::: {.columns}\n::: {.column width=30%}\n\nWe'll track the mass balance in terms of rates (not absolute mass).\n\nWhat happens to an element of water?\n:::\n::: {.column width=70%}\n\n![Processes influencing oxygen balance in moving freshwater](figures/do-processes.svg)\n:::\n::::\n\n## Steady-State Waste, DO Mass Balance\n\nLet $U$ be the river velocity (km/d), $x$ the distance downstream from a waste release site in km, and $C(x)$ the DO concentration at $x$ in mg/L. \n\n\\begin{align}\nU \\frac{dC}{dx} &= \\text{Change in DO} \\\\[0.5em]\n&= \\text{Reaeration} + \\text{Photosynthesis} - \\text{Respiration}  \\\\[0.5em]\n& \\qquad - \\text{Benthal Uptake} - \\text{CBOD} - \\text{NBOD}\n\n\\end{align}\n\n## BOD Oxygen Uptake\n\nAssume deoxygenation from waste decomposition is first-order (rate $k$):\n\n$$\\begin{aligned}\n\\frac{dM}{dt} &= -kM \\\\\n\\Rightarrow M &= M_0 \\exp(-kt)\n\\end{aligned}$$\n\n\n::: {.fragment .fade-in}\nBut our equations are formulated in terms of distance:\n\n$$M = M_0 \\exp(-kx/U)$$\n\n:::\n\n\n## BOD Oxygen Uptake\n\nFor biochemical organics, if $k_c$ is the deoxygenation rate (d$^{-1}$);\n\n$$B(x) = B_0 \\exp(-k_c x / U);$$\n\nFor nitrification, if $k_n$ is the deoxygenation rate (d$^{-1}$):\n\n$$N(x) = N_0 \\exp(-k_n x / U).$$\n\n## Steady-State Waste, DO Mass Balance\n\nSo the corresponding oxygen uptake rates are \n$$k_c B(x) = k_c B_0 \\exp(-k_c x / U)$$\n and \n\n $$k_n N(x) = k_n N_0 \\exp(-k_n x / U).$$\n\n\n## Steady-State Waste, DO Mass Balance\n\nOther processes:\n\n- Reaeration, assume a simple linear model based on difference from saturation level $C_s$: $k_a (C_s - C)$\n\n- Assume measured, constant values for photosynthesis ($P_s$), respiration ($R$), benthal uptake ($S_B$)\n\n## Steady-State Waste, DO Mass Balance\n\nPutting it all together:\n\n$$\n\\begin{aligned}\nU \\frac{dC}{dx} &= k_a (C_s - C) + P - R - S_B \\\\\n&\\quad - k_cB_0\\exp\\left(\\frac{-k_cx}{U}\\right) - k_n N_0\\exp\\left(\\frac{-k_nx}{U}\\right)\n\\end{aligned}\n$$\n\n## Discretization of Steady-State DO Equation\n\n$$\n\\begin{align*}\nU \\frac{C(x+1) - C(x)}{\\Delta x} &= k_a (C_s - C(x)) + P - R - S_B \\\\\n&\\quad - k_c B(x) - k_n N(x) \\\\[0.5em]\n\\frac{N(x+1) - N(x)}{\\Delta x} &= \n\\end{align*}\n$$\n\n## Discretization of Steady-State DO Equations\n\n$$\n\\begin{align*}\nC(x+1) &= C(x) + \\frac{\\Delta x}{U}{\\huge[}k_a (C_s - C(x)) + P - R - S_B \\\\\n&\\quad - k_c B(x) - k_n N(x)\\right){\\huge]} \\\\[0.5em]\nN(x+1) &= N(x) + \\frac{\\Delta x}\n\\end{align*}\n$$\n\n::: {.fragment .fade-in}\n**Note**: Usually models ignore $P$, R$, and $S_B$. \n\n**Why do you think that might be?**\n\n# Simulation Results\n\n## How To Simulate\n\nThis is similar to the multi-box example from last time!\n\nSingle equation, straightforward to evaluate across many values of $x$ with a loop.\n\n```julia\nx = 0:x_step:x_max # array from 0 to x_max in stepsize x_step\n\nC = zeroes(length(x)) # initialize storage\nfor (i, y) in pairs(x)\n    C[i] = dissolved_oxygen(y, parameters)\nend\n```\n\n## Julia Sidebar: Loop Alternatives\n\nLoops in Julia are fast and should be used freely. \n\nBut there are some more concise alternatives, which may be more readable in some cases.\n\n## Julia Sidebar: Broadcasting\n\nBut some more concise alternatives (which may be more readable) include **broadcasting**:\n\n```julia\nx = 0:x_step:x_max # array from 0 to x_max in stepsize x_step\n\n# evaluate DO function over every x with fixed parameters\nC = (y -> dissolved_oxygen(y, parameters)).(x) \n```\n\nBroadcasting gets finicky over multiple inputs.\n\n## Julia Sidebar: Comprehensions\n\n...And **comprehensions** (in-line for loops, also in Python):\n\n```julia\nx = 0:x_step:x_max # array from 0 to x_max in stepsize x_step\n\n# evaluate DO function over every x with fixed parameters\nC = [dissolved_oxygen(y, parameters) for y in x]\n```\n\nCan \"stack\" the `for` loops in a comprehension to nest.\n\n## Julia Sidebar: When To Use Loops?\n\nThink about readability and ease of debugging!\n\n- If your code is complex and not wrapped in a function, or you have several nested loops, you should use a loop (*just be careful of scope...*)\n- If your code is complex, may be worth asking if you should write a function instead and use broadcasting or a comprehension.\n\n## Simulation Outputs\n\n\n\n\n::: {#6 .cell execution_count=1}\n\n::: {.cell-output .cell-output-display execution_count=1}\n```\ndo_simulate (generic function with 1 method)\n```\n:::\n:::\n\n\n\n\n\n\n# Key Points\n\n## Key Points\n\n- Dissolved oxygen (DO) is essential for water quality and aquatic life.\n- Commonly regulated to keep DO above a minimum threshold.\n- DO impacted by a number of factors, notably organic waste decomposition and nitrification.\n- We derived a first-order equation for DO using mass-balance and fate & transport principles.\n\n",
    "supporting": [
      "lecture03-2-dissolved-oxygen_files"
    ],
    "filters": [],
    "includes": {}
  }
}